# Sitemap Diff - é¡¹ç›®æ–‡æ¡£

## é¡¹ç›®æ¦‚è¿°
ç›‘æ§å¤šä¸ªç½‘ç«™çš„ sitemapï¼Œæ£€æµ‹æ–°å¢æ¸¸æˆï¼Œè¿½è¸ªè·¨å¹³å°æ¸¸æˆã€‚æä¾› Web Dashboard è¿›è¡Œç®¡ç†ã€‚

## æ¶æ„ (V2.0)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GitHub Actions     â”‚â”€â”€â”€â”€â–¶â”‚  Supabase       â”‚
â”‚  (å®šæ—¶æ£€æŸ¥ sitemap) â”‚     â”‚  (æ•°æ®å­˜å‚¨)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  Web Dashboard      â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  (Vercel Next.js)   â”‚
â”‚  - æ¸¸æˆæµè§ˆ         â”‚
â”‚  - Sitemap ç®¡ç†     â”‚
â”‚  - ç»Ÿè®¡é¢æ¿         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç»„ä»¶è¯´æ˜
- **GitHub Actions**: æ¯ 4 å°æ—¶å®šæ—¶æ‰§è¡Œ sitemap æ£€æŸ¥ï¼Œæ—  CPU é™åˆ¶
- **Supabase**: å­˜å‚¨æ¸¸æˆæ•°æ®ã€æ¸¸æˆæ¥æºã€è®¢é˜…æº
- **Web Dashboard**: Next.js åº”ç”¨ï¼Œæä¾›å¯è§†åŒ–ç®¡ç†ç•Œé¢
  - å®æ—¶ç»Ÿè®¡é¢æ¿
  - æ¸¸æˆæµè§ˆå’Œæœç´¢
  - Sitemap ç®¡ç†
  - è·¨å¹³å°æ¸¸æˆè¿½è¸ª

## ç›®å½•ç»“æ„

```
sitemap-diff/
â”œâ”€â”€ lib/                      # çˆ¬è™«æ ¸å¿ƒåº“
â”‚   â”œâ”€â”€ supabase.js           # Supabase å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ rss-manager.js        # RSS ç®¡ç†å™¨ï¼ˆæ¸¸æˆæå–ï¼‰
â”‚   â”œâ”€â”€ check-sitemaps.js     # å®šæ—¶æ£€æŸ¥è„šæœ¬
â”‚   â””â”€â”€ load-env.js           # ç¯å¢ƒå˜é‡åŠ è½½
â”œâ”€â”€ web/                      # Web Dashboard (Next.js)
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/       # React ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ pages/            # é¡µé¢ (Dashboard, Games, Sitemaps)
â”‚   â”‚   â”œâ”€â”€ lib/              # Supabase å®¢æˆ·ç«¯
â”‚   â”‚   â””â”€â”€ styles/           # å…¨å±€æ ·å¼
â”‚   â”œâ”€â”€ public/               # é™æ€èµ„æº
â”‚   â””â”€â”€ package.json
â”œâ”€â”€ supabase/
â”‚   â”œâ”€â”€ schema.sql            # V2 æ•°æ®åº“è¡¨ç»“æ„
â”‚   â””â”€â”€ migration.sql         # V1â†’V2 è¿ç§»è„šæœ¬
â”œâ”€â”€ .github/workflows/
â”‚   â””â”€â”€ check-sitemaps.yml    # GitHub Actions
â”œâ”€â”€ vercel.json               # Vercel é…ç½®ï¼ˆAPI + Webï¼‰
â””â”€â”€ package.json              # çˆ¬è™«ä¾èµ–
```

## ç¯å¢ƒå˜é‡

### GitHub Actions Secrets
- `SUPABASE_URL` - Supabase é¡¹ç›® URL
- `SUPABASE_SERVICE_KEY` - Supabase æœåŠ¡å¯†é’¥

### Vercel Environment Variables
- `NEXT_PUBLIC_SUPABASE_URL` - Supabase é¡¹ç›® URLï¼ˆå…¬å¼€ï¼‰
- `NEXT_PUBLIC_SUPABASE_ANON_KEY` - Supabase Publishable/Anon Keyï¼ˆå…¬å¼€ï¼‰

## éƒ¨ç½²æ­¥éª¤

### 1. åˆ›å»º Supabase é¡¹ç›®
1. åœ¨ Supabase åˆ›å»ºæ–°é¡¹ç›®
2. æ‰§è¡Œ `supabase/schema.sql` åˆ›å»ºè¡¨

### 2. éƒ¨ç½² Web Dashboard åˆ° Vercel
```bash
cd web
npm install
cd ..
vercel deploy --prod
```

åœ¨ Vercel é¡¹ç›®è®¾ç½®ä¸­æ·»åŠ ç¯å¢ƒå˜é‡ï¼š
- `NEXT_PUBLIC_SUPABASE_URL` - ä» Supabase Dashboard è·å–
- `NEXT_PUBLIC_SUPABASE_ANON_KEY` - ä» Supabase Dashboard è·å–

### 3. é…ç½® GitHub Actions
åœ¨ä»“åº“ Settings > Secrets æ·»åŠ æ‰€æœ‰ç¯å¢ƒå˜é‡ï¼š
- `SUPABASE_URL`
- `SUPABASE_SERVICE_KEY`

### 4. è®¿é—® Dashboard
éƒ¨ç½²æˆåŠŸåï¼Œè®¿é—®ä½ çš„ Vercel åŸŸåå³å¯ä½¿ç”¨ç®¡ç†ç•Œé¢

## å¼€å‘å‘½ä»¤

### çˆ¬è™«
```bash
npm run check    # æœ¬åœ°è¿è¡Œ sitemap æ£€æŸ¥
```

### Web Dashboard
```bash
cd web
npm install      # å®‰è£…ä¾èµ–
npm run dev      # æœ¬åœ°å¼€å‘æœåŠ¡å™¨ (http://localhost:3000)
npm run build    # æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm start        # å¯åŠ¨ç”Ÿäº§æœåŠ¡å™¨
```

## Web Dashboard åŠŸèƒ½

### ğŸ“Š Dashboard é¡µé¢
- å®æ—¶ç»Ÿè®¡å¡ç‰‡ï¼ˆæ€»æ¸¸æˆæ•°ã€å¹³å°æ•°ã€è·¨å¹³å°æ¸¸æˆã€é«˜åˆ†æ¸¸æˆï¼‰
- Top 6 è·¨å¹³å°æ¸¸æˆå±•ç¤º
- ç³»ç»ŸçŠ¶æ€æŒ‡ç¤ºå™¨

### ğŸ® Games é¡µé¢
- æ‰€æœ‰æ¸¸æˆåˆ—è¡¨ï¼ˆæŒ‰åˆ†æ•°æ’åºï¼‰
- æœç´¢åŠŸèƒ½ï¼ˆæ¸¸æˆåç§°ï¼‰
- ç­›é€‰åŠŸèƒ½ï¼š
  - æŒ‰å¹³å°æ•°é‡ï¼ˆ2+, 3+, 4+ï¼‰
  - æŒ‰åŸŸå
- æ¯ä¸ªæ¸¸æˆæ˜¾ç¤ºï¼š
  - æ¸¸æˆåç§°å’Œ ID
  - å¹³å°æ•°é‡ badge
  - æ¨èåˆ†æ•°ï¼ˆå¸¦è¿›åº¦æ¡ï¼‰
  - æ‰€æœ‰å¹³å°é“¾æ¥

### ğŸ—ºï¸ Sitemaps é¡µé¢
- æ‰€æœ‰é…ç½®çš„ sitemap åˆ—è¡¨
- æ·»åŠ æ–° sitemapï¼ˆURL è¾“å…¥ï¼‰
- åˆ é™¤ sitemap
- æ˜¾ç¤ºåŸŸåã€æ·»åŠ æ—¶é—´ã€æ›´æ–°æ—¶é—´

## è®¾è®¡ç‰¹è‰²

- **èµ›åšæœ‹å…‹éœ“è™¹é£æ ¼**ï¼šé’è‰²+æ´‹çº¢è‰²+é»„è‰²çš„éœ“è™¹é…è‰²
- **ç‹¬ç‰¹å­—ä½“**ï¼šRajdhaniï¼ˆæ˜¾ç¤ºï¼‰+ JetBrains Monoï¼ˆä»£ç ï¼‰
- **æµç•…åŠ¨ç”»**ï¼šæ•°å­—è®¡æ•°ã€å¡ç‰‡æ‚¬æµ®ã€é¡µé¢åŠ è½½
- **å“åº”å¼è®¾è®¡**ï¼šå®Œç¾æ”¯æŒç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯

## æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

### 1. Sitemap æ£€æŸ¥æœºåˆ¶

**å¯¹æ¯”å‰åç‰ˆæœ¬ï¼Œåªå¤„ç†æ–°å¢ URL**

```javascript
// ä¸‹è½½æ–° sitemap
const newUrls = extractURLs(newContent);

// è·å–æ—§ sitemap
const oldContent = await getSitemapContent(domain);
if (oldContent) {
  const oldUrls = extractURLs(oldContent);
  // æ‰¾å‡ºæ–°å¢çš„ URLï¼ˆå·®å¼‚å¯¹æ¯”ï¼‰
  const oldUrlSet = new Set(oldUrls);
  diffUrls = newUrls.filter(u => !oldUrlSet.has(u));
} else {
  // é¦–æ¬¡æ£€æŸ¥ï¼šä¿å­˜ä½†ä¸å¤„ç†ï¼ˆä¸‹æ¬¡æ‰å¯¹æ¯”ï¼‰
  await saveSitemapContent(domain, newContent, newUrls.length);
}

// å¤„ç†æ–°å¢ URLï¼Œæå–æ¸¸æˆ
for (const url of diffUrls) {
  const gameInfo = extractGameName(url);
  if (gameInfo) {
    await upsertGame(gameInfo.name, gameInfo.cleanName, domain, url);
  }
}
```

### 2. æ¸¸æˆåç§°æå–ä¸è¿‡æ»¤

**ä» URL ä¸­æå–æ¸¸æˆåï¼Œæ’é™¤åˆ†ç±»é¡µé¢**

```javascript
function extractGameName(url) {
  // ç¬¬ä¸€æ­¥ï¼šæ’é™¤éæ¸¸æˆé¡µé¢è·¯å¾„
  const excludePatterns = [
    /\/(tag|category|genre|author|user)\//,
    /\/(about|contact|privacy|terms|faq)\/,
    /\/(sitemap|robots|feed|rss|atom)($|\/|\.|\.xml)/
  ];

  // ç¬¬äºŒæ­¥ï¼šæŒ‰å¹³å°è§„åˆ™æå–æ¸¸æˆå
  // poki.com/en/g/game-name
  // coolmathgames.com/0-game-name
  // itch.io å­åŸŸåå½¢å¼
  // ...

  // ç¬¬ä¸‰æ­¥ï¼šæ’é™¤åˆ†ç±»å…³é”®è¯
  const categoryKeywords = [
    'action-games', 'puzzle-games', 'casual-games',
    'new-games', 'hot-games', 'popular-games',
    // ...
  ];

  // æ¨¡ç³ŠåŒ¹é…ï¼šä»¥ -games ç»“å°¾çš„ï¼ˆæ’é™¤çœŸå®æ¸¸æˆåï¼‰
  if (/-games?$/.test(lowerGameName)) {
    const validGamePatterns = [
      /hunger-games?$/, /squid-games?$/
    ];
    if (!validGamePatterns.some(p => p.test(lowerGameName))) {
      return null;  // æ’é™¤åˆ†ç±»é¡µé¢
    }
  }

  return { name: gameName, cleanName: normalizeGameName(gameName) };
}
```

### 3. å¼‚å¸¸æ£€æµ‹ä¸æ•°æ®ä¿æŠ¤

**é˜²æ­¢ç©º sitemap æ±¡æŸ“æ•°æ®åº“**

```javascript
// æ£€æµ‹ 1: é›¶ URL
if (newUrls.length === 0) {
  return { success: false, errorMsg: 'æœªèƒ½æå–åˆ° URL' };
}

// æ£€æµ‹ 2: URL æ•°é‡éª¤å‡ï¼ˆå·²æœ‰æ—§æ•°æ®æ—¶ï¼‰
if (oldUrls.length > 0 && newUrls.length < oldUrls.length * 0.5) {
  return { success: false, errorMsg: 'URL æ•°é‡å¼‚å¸¸' };
}

// æ£€æµ‹ 3: é¦–æ¬¡æ£€æŸ¥æœ€å°é˜ˆå€¼
if (!oldContent && newUrls.length < 10) {
  return { success: false, errorMsg: 'é¦–æ¬¡æ£€æŸ¥ URL æ•°é‡è¿‡å°‘' };
}
```

### 4. è·¨å¹³å°æ¸¸æˆè¿½è¸ª

**é€šè¿‡æ ‡å‡†åŒ–åç§°åŒ¹é…åŒä¸€æ¸¸æˆ**

```javascript
// æ ‡å‡†åŒ–ï¼šsubway-surfers â†’ subwaysurfers
function normalizeGameName(name) {
  return name.toLowerCase()
    .replace(/[-_\s]+/g, '-')
    .replace(/[^a-z0-9-]/g, '')
    .replace(/^-+|-+$/g, '')
    .replace(/-+/g, '-');
}

// åˆ›å»º/æ›´æ–°æ¸¸æˆ
async function upsertGame(name, cleanName, domain, url) {
  // 1. é€šè¿‡ cleanName æŸ¥æ‰¾æ¸¸æˆ
  let game = await findGameByCleanName(cleanName);

  if (!game) {
    // æ–°æ¸¸æˆï¼šåˆ›å»ºè®°å½•
    game = await createGame(name, cleanName);
  }

  // 2. æ·»åŠ æ¸¸æˆæ¥æº
  const source = await addGameSource(game.id, domain, url);

  // 3. æ›´æ–°å¹³å°è®¡æ•°
  if (source.isNew) {
    await updatePlatformCount(game.id);
  }

  return { game, isNew: !existingGame, isCrossPlatform: game.platform_count > 1 };
}
```

### 5. æ•°æ®åº“è¡¨ç»“æ„

**games (æ¸¸æˆè¡¨)**: æ¯ä¸ªæ¸¸æˆå”¯ä¸€è®°å½•
- `clean_name`: æ ‡å‡†åŒ–åç§°ï¼ˆç”¨äºè·¨å¹³å°åŒ¹é…ï¼‰
- `platform_count`: å‡ºç°åœ¨å¤šå°‘ä¸ªå¹³å°

**game_sources (æ¸¸æˆæ¥æºè¡¨)**: æ¸¸æˆåœ¨å„å¹³å°çš„å…·ä½“ URL
- `game_id`: å…³è”åˆ° games è¡¨
- `domain`: å¹³å°åŸŸå
- `url`: æ¸¸æˆåœ¨è¯¥å¹³å°çš„ URL
- çº¦æŸï¼š`UNIQUE(game_id, domain)` - æ¯ä¸ªæ¸¸æˆåœ¨åŒä¸€å¹³å°åªæœ‰ä¸€æ¡è®°å½•

**sitemaps (Sitemap å†…å®¹è¡¨)**: å­˜å‚¨ sitemap ç”¨äºç‰ˆæœ¬å¯¹æ¯”
- `domain`: åŸŸå
- `content`: å®Œæ•´ sitemap XML å†…å®¹
- `url_count`: URL æ•°é‡

## ç»´æŠ¤å·¥å…·

### æ•°æ®è¯Šæ–­
```bash
# åœ¨ Supabase SQL Editor æ‰§è¡Œ
supabase/diagnose-pollution.sql
```
æ£€æŸ¥ï¼š
- å¼‚å¸¸çš„ sitemap è®°å½•ï¼ˆurl_count < 10ï¼‰
- æœ€è¿‘æ¸¸æˆå¢é•¿ç»Ÿè®¡
- å„åŸŸåæ¸¸æˆæ•°é‡

### æ•°æ®æ¸…ç†
```bash
# åœ¨ Supabase SQL Editor æ‰§è¡Œ
supabase/clean-polluted-data.sql
```
æä¾› 4 ç§æ¸…ç†æ–¹æ¡ˆï¼š
1. åªæ¸…ç†å¼‚å¸¸ sitemapï¼ˆæ¨èï¼‰
2. æ¸…ç†ç‰¹å®šåŸŸåçš„æ¸¸æˆæ•°æ®
3. æŒ‰æ—¶é—´æ¸…ç†æ±¡æŸ“æ•°æ®
4. å®Œå…¨é‡ç½®ï¼ˆç»ˆææ–¹æ¡ˆï¼‰

### Schema åˆ·æ–°
å¦‚æœé‡åˆ° `PGRST204` é”™è¯¯ï¼ˆPostgREST ç¼“å­˜è¿‡æœŸï¼‰ï¼š
```sql
-- åœ¨ Supabase SQL Editor æ‰§è¡Œ
NOTIFY pgrst, 'reload schema';
```

æˆ–åœ¨ Supabase Dashboard â†’ Settings â†’ API â†’ é‡å¯ PostgREST

## å·²çŸ¥é—®é¢˜ä¸è§£å†³

### 1. TypeScript ç¼–è¯‘é”™è¯¯
**é—®é¢˜**: `Type 'Set<string>' can only be iterated through when using '--downlevelIteration'`
**è§£å†³**: ä¿®æ”¹ `web/tsconfig.json`ï¼Œå°† `target` ä» `"es5"` æ”¹ä¸º `"es2015"`

### 2. Vercel æ„å»ºå¤±è´¥ï¼šç¼ºå°‘ TypeScript
**é—®é¢˜**: `devDependencies` åœ¨ç”Ÿäº§æ„å»ºæ—¶ä¸å®‰è£…
**è§£å†³**: å°† `typescript`, `@types/*`, `tailwindcss` ç­‰ç§»è‡³ `dependencies`

### 3. PostgREST Schema ç¼“å­˜
**é—®é¢˜**: æ•°æ®åº“è¡¨ç»“æ„æ›´æ–°å API ä»æŠ¥é”™ `column does not exist`
**è§£å†³**: æ‰§è¡Œ `NOTIFY pgrst, 'reload schema';` æˆ–é‡å¯ PostgREST

### 4. ç©º Sitemap æ±¡æŸ“æ•°æ®åº“
**é—®é¢˜**: é¦–æ¬¡è§£æå‡º 0 ä¸ª URLï¼Œå¯¼è‡´ä¸‹æ¬¡æŠŠæ‰€æœ‰æ¸¸æˆè¯¯åˆ¤ä¸ºæ–°æ¸¸æˆ
**è§£å†³**: æ·»åŠ ä¸‰å±‚å¼‚å¸¸æ£€æµ‹ï¼ˆé›¶ URLã€æ•°é‡éª¤å‡ã€é¦–æ¬¡æœ€å°é˜ˆå€¼ï¼‰

## å¼€å‘å†å²

### V2.0 (2025-01-20)
- âœ… ä¿®å¤æ ¸å¿ƒé€»è¾‘ï¼šä»æ•°æ®åº“æ£€æŸ¥æ”¹ä¸º sitemap ç‰ˆæœ¬å¯¹æ¯”
- âœ… å¢å¼ºæ¸¸æˆè¿‡æ»¤ï¼šæ’é™¤åˆ†ç±»é¡µé¢ï¼ˆaction-games, puzzle-games ç­‰ï¼‰
- âœ… æ·»åŠ å¼‚å¸¸æ£€æµ‹ï¼šé˜²æ­¢ç©º sitemap æ±¡æŸ“æ•°æ®åº“
- âœ… åˆ é™¤é€šçŸ¥åŠŸèƒ½ï¼šç§»é™¤ Discord/Telegram ç›¸å…³ä»£ç 
- âœ… ä¿®å¤æ„å»ºé—®é¢˜ï¼šTypeScript ç¼–è¯‘é”™è¯¯ã€Vercel éƒ¨ç½²é…ç½®
- âœ… æ·»åŠ ç»´æŠ¤å·¥å…·ï¼šæ•°æ®è¯Šæ–­ã€æ¸…ç†è„šæœ¬
- âœ… è°ƒæ•´å®šæ—¶é¢‘ç‡ï¼šä» 8 å°æ—¶æ”¹ä¸º 4 å°æ—¶

### V1.0 (2024)
- åˆå§‹ç‰ˆæœ¬ï¼šCloudflare Workers + KV å­˜å‚¨
- Discord/Telegram é€šçŸ¥åŠŸèƒ½
